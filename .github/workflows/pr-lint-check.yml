name: PR Lint and Format Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.js'
      - '**.jsx'
      - '**.ts'
      - '**.tsx'
      - '**.json'
      - '**.cjs'
      - '**.mjs'
      - '.prettierrc'
      - '.eslintrc.cjs'
      - 'package.json'

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    name: Check Code Quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          # å®‰è£… web ç›®å½•çš„ä¾èµ–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "web/admin-spa" ] && [ -f "web/admin-spa/package.json" ]; then
            cd web/admin-spa
            npm ci --prefer-offline --no-audit
            cd ../..
          fi

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.js
            **/*.jsx
            **/*.ts
            **/*.tsx
            **/*.cjs
            **/*.mjs
            **/*.json
          files_ignore: |
            node_modules/**
            dist/**
            build/**
            coverage/**
            .git/**
            logs/**
            temp/**
            tmp/**

      - name: Check Prettier formatting
        if: steps.changed-files.outputs.any_changed == 'true'
        id: prettier-check
        run: |
          echo "ğŸ” Checking Prettier formatting for changed files..."
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          
          # åˆå§‹åŒ–æ ‡å¿—
          PRETTIER_FAILED=false
          PRETTIER_OUTPUT=""
          
          # æ£€æŸ¥æ¯ä¸ªæ”¹å˜çš„æ–‡ä»¶
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ -f "$file" ]; then
              echo "Checking: $file"
              # ä½¿ç”¨ prettier --check æ¥æ£€æŸ¥æ ¼å¼
              if ! npx prettier --check "$file" 2>&1; then
                PRETTIER_FAILED=true
                # è·å–éœ€è¦æ ¼å¼åŒ–çš„å·®å¼‚
                DIFF=$(npx prettier "$file" | diff -u "$file" - || true)
                if [ -n "$DIFF" ]; then
                  PRETTIER_OUTPUT="${PRETTIER_OUTPUT}âŒ File needs formatting: $file\n"
                  PRETTIER_OUTPUT="${PRETTIER_OUTPUT}\`\`\`diff\n${DIFF}\n\`\`\`\n\n"
                fi
              else
                echo "âœ… $file is properly formatted"
              fi
            fi
          done
          
          # è¾“å‡ºç»“æœ
          if [ "$PRETTIER_FAILED" = true ]; then
            echo "prettier_failed=true" >> $GITHUB_OUTPUT
            # å°†æ ¼å¼åŒ–å»ºè®®ä¿å­˜åˆ°æ–‡ä»¶
            echo -e "$PRETTIER_OUTPUT" > prettier-report.md
            echo "âŒ Some files are not properly formatted. Please run: npm run format"
            exit 1
          else
            echo "prettier_failed=false" >> $GITHUB_OUTPUT
            echo "âœ… All files are properly formatted"
          fi

      - name: Run ESLint
        if: steps.changed-files.outputs.any_changed == 'true'
        id: eslint-check
        run: |
          echo "ğŸ” Running ESLint on changed files..."
          
          # è¿‡æ»¤å‡º JavaScript æ–‡ä»¶
          JS_FILES=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" =~ \.(js|jsx|cjs|mjs)$ ]] && [ -f "$file" ]; then
              JS_FILES="$JS_FILES $file"
            fi
          done
          
          if [ -n "$JS_FILES" ]; then
            echo "Linting files: $JS_FILES"
            
            # è¿è¡Œ ESLint å¹¶æ•è·è¾“å‡º
            set +e
            ESLINT_OUTPUT=$(npx eslint $JS_FILES --format stylish 2>&1)
            ESLINT_EXIT_CODE=$?
            set -e
            
            # ä¿å­˜ ESLint æŠ¥å‘Š
            echo "$ESLINT_OUTPUT" > eslint-report.txt
            
            if [ $ESLINT_EXIT_CODE -ne 0 ]; then
              echo "eslint_failed=true" >> $GITHUB_OUTPUT
              echo "âŒ ESLint found issues:"
              echo "$ESLINT_OUTPUT"
              
              # åˆ›å»ºæ›´å‹å¥½çš„é”™è¯¯æŠ¥å‘Š
              echo "## ESLint Report" > eslint-report.md
              echo '```' >> eslint-report.md
              echo "$ESLINT_OUTPUT" >> eslint-report.md
              echo '```' >> eslint-report.md
              echo "" >> eslint-report.md
              echo "Please fix these issues by running:" >> eslint-report.md
              echo '```bash' >> eslint-report.md
              echo "npx eslint --fix $JS_FILES" >> eslint-report.md
              echo '```' >> eslint-report.md
              
              exit 1
            else
              echo "eslint_failed=false" >> $GITHUB_OUTPUT
              echo "âœ… ESLint check passed"
            fi
          else
            echo "No JavaScript files to lint"
          fi

      - name: Comment PR with results
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let comment = '## ğŸš¨ Code Quality Check Failed\n\n';
            
            // è¯»å– Prettier æŠ¥å‘Š
            if (fs.existsSync('prettier-report.md')) {
              const prettierReport = fs.readFileSync('prettier-report.md', 'utf8');
              comment += '### Prettier Formatting Issues\n\n';
              comment += prettierReport;
              comment += '\n**Fix command:**\n```bash\nnpm run format\n```\n\n';
            }
            
            // è¯»å– ESLint æŠ¥å‘Š
            if (fs.existsSync('eslint-report.md')) {
              const eslintReport = fs.readFileSync('eslint-report.md', 'utf8');
              comment += '### ESLint Issues\n\n';
              comment += eslintReport;
            }
            
            comment += '\n---\n';
            comment += 'ğŸ’¡ **æç¤º**: åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è‡ªåŠ¨ä¿®å¤å¤§éƒ¨åˆ†é—®é¢˜:\n';
            comment += '```bash\n';
            comment += 'npm run format    # ä¿®å¤ Prettier æ ¼å¼é—®é¢˜\n';
            comment += 'npm run lint:fix  # ä¿®å¤ ESLint é—®é¢˜\n';
            comment += '```\n';
            
            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Code Quality Check Failed')
            );
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Success comment
        if: success() && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰å¤±è´¥çš„è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Code Quality Check Failed')
            );
            
            if (botComment) {
              // å¦‚æœä¹‹å‰æœ‰å¤±è´¥è¯„è®ºï¼Œæ›´æ–°ä¸ºæˆåŠŸ
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: '## âœ… Code Quality Check Passed\n\nAll files are properly formatted and pass linting checks!'
              });
            }