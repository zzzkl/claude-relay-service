name: PR Lint and Format Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.js'
      - '**.jsx'
      - '**.ts'
      - '**.tsx'
      - '**.vue'
      - '**.json'
      - '**.cjs'
      - '**.mjs'
      - '.prettierrc'
      - '.eslintrc.cjs'
      - 'package.json'
      - 'web/admin-spa/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    name: Check Code Quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          # å®‰è£… web ç›®å½•çš„ä¾èµ–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "web/admin-spa" ] && [ -f "web/admin-spa/package.json" ]; then
            cd web/admin-spa
            npm ci --prefer-offline --no-audit
            cd ../..
          fi

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.js
            **/*.jsx
            **/*.ts
            **/*.tsx
            **/*.vue
            **/*.cjs
            **/*.mjs
            **/*.json
          files_ignore: |
            node_modules/**
            dist/**
            build/**
            coverage/**
            .git/**
            logs/**
            temp/**
            tmp/**

      - name: Check Prettier formatting
        if: steps.changed-files.outputs.any_changed == 'true'
        id: prettier-check
        run: |
          echo "ğŸ” Checking Prettier formatting for changed files..."
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          
          # åˆå§‹åŒ–æ ‡å¿—
          PRETTIER_FAILED=false
          PRETTIER_OUTPUT=""
          
          # æ£€æŸ¥æ¯ä¸ªæ”¹å˜çš„æ–‡ä»¶
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ -f "$file" ]; then
              echo "Checking: $file"
              
              # æ ¹æ®æ–‡ä»¶ä½ç½®é€‰æ‹©æ­£ç¡®çš„ prettier é…ç½®
              if [[ "$file" == web/admin-spa/* ]]; then
                # å‰ç«¯æ–‡ä»¶ï¼šè¿›å…¥å‰ç«¯ç›®å½•è¿è¡Œ prettier
                cd web/admin-spa
                RELATIVE_FILE="${file#web/admin-spa/}"
                if ! npx prettier --check "$RELATIVE_FILE" 2>&1; then
                  PRETTIER_FAILED=true
                  DIFF=$(npx prettier "$RELATIVE_FILE" | diff -u "$RELATIVE_FILE" - || true)
                  if [ -n "$DIFF" ]; then
                    PRETTIER_OUTPUT="${PRETTIER_OUTPUT}âŒ File needs formatting: $file\n"
                    PRETTIER_OUTPUT="${PRETTIER_OUTPUT}\`\`\`diff\n${DIFF}\n\`\`\`\n\n"
                  fi
                else
                  echo "âœ… $file is properly formatted"
                fi
                cd ../..
              else
                # åç«¯æ–‡ä»¶ï¼šä½¿ç”¨æ ¹ç›®å½•çš„ prettier
                if ! npx prettier --check "$file" 2>&1; then
                  PRETTIER_FAILED=true
                  DIFF=$(npx prettier "$file" | diff -u "$file" - || true)
                  if [ -n "$DIFF" ]; then
                    PRETTIER_OUTPUT="${PRETTIER_OUTPUT}âŒ File needs formatting: $file\n"
                    PRETTIER_OUTPUT="${PRETTIER_OUTPUT}\`\`\`diff\n${DIFF}\n\`\`\`\n\n"
                  fi
                else
                  echo "âœ… $file is properly formatted"
                fi
              fi
            fi
          done
          
          # è¾“å‡ºç»“æœ
          if [ "$PRETTIER_FAILED" = true ]; then
            echo "prettier_failed=true" >> $GITHUB_OUTPUT
            echo -e "$PRETTIER_OUTPUT" > prettier-report.md
            echo "âŒ Some files are not properly formatted."
            echo "Please run: npm run format (backend) or cd web/admin-spa && npm run format (frontend)"
            exit 1
          else
            echo "prettier_failed=false" >> $GITHUB_OUTPUT
            echo "âœ… All files are properly formatted"
          fi

      - name: Run ESLint
        if: steps.changed-files.outputs.any_changed == 'true'
        id: eslint-check
        run: |
          echo "ğŸ” Running ESLint on changed files..."
          
          # åˆ†ç¦»å‰ç«¯å’Œåç«¯æ–‡ä»¶
          BACKEND_FILES=""
          FRONTEND_FILES=""
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" =~ \.(js|jsx|vue|cjs|mjs)$ ]] && [ -f "$file" ]; then
              if [[ "$file" == web/admin-spa/* ]]; then
                FRONTEND_FILES="$FRONTEND_FILES ${file#web/admin-spa/}"
              else
                BACKEND_FILES="$BACKEND_FILES $file"
              fi
            fi
          done
          
          ESLINT_FAILED=false
          ESLINT_OUTPUT=""
          
          # æ£€æŸ¥åç«¯æ–‡ä»¶
          if [ -n "$BACKEND_FILES" ]; then
            echo "Linting backend files: $BACKEND_FILES"
            set +e
            BACKEND_OUTPUT=$(npx eslint $BACKEND_FILES --format stylish 2>&1)
            BACKEND_EXIT_CODE=$?
            set -e
            
            if [ $BACKEND_EXIT_CODE -ne 0 ]; then
              ESLINT_FAILED=true
              ESLINT_OUTPUT="${ESLINT_OUTPUT}### Backend ESLint Issues\n\`\`\`\n${BACKEND_OUTPUT}\n\`\`\`\n\n"
            fi
          fi
          
          # æ£€æŸ¥å‰ç«¯æ–‡ä»¶
          if [ -n "$FRONTEND_FILES" ]; then
            echo "Linting frontend files: $FRONTEND_FILES"
            cd web/admin-spa
            set +e
            FRONTEND_OUTPUT=$(npx eslint $FRONTEND_FILES --format stylish 2>&1)
            FRONTEND_EXIT_CODE=$?
            set -e
            cd ../..
            
            if [ $FRONTEND_EXIT_CODE -ne 0 ]; then
              ESLINT_FAILED=true
              ESLINT_OUTPUT="${ESLINT_OUTPUT}### Frontend ESLint Issues\n\`\`\`\n${FRONTEND_OUTPUT}\n\`\`\`\n\n"
            fi
          fi
          
          # è¾“å‡ºç»“æœ
          if [ "$ESLINT_FAILED" = true ]; then
            echo "eslint_failed=true" >> $GITHUB_OUTPUT
            echo "âŒ ESLint found issues"
            
            # åˆ›å»ºé”™è¯¯æŠ¥å‘Š
            echo "## ESLint Report" > eslint-report.md
            echo "$ESLINT_OUTPUT" >> eslint-report.md
            echo "" >> eslint-report.md
            echo "Please fix these issues by running:" >> eslint-report.md
            echo '```bash' >> eslint-report.md
            echo "# Backend: npm run lint" >> eslint-report.md
            echo "# Frontend: cd web/admin-spa && npm run lint" >> eslint-report.md
            echo '```' >> eslint-report.md
            
            exit 1
          else
            echo "eslint_failed=false" >> $GITHUB_OUTPUT
            echo "âœ… ESLint check passed"
          fi

      - name: Debug PR Context
        if: failure()
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Repo: ${{ github.repository }}"
          echo "Event Name: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"

      - name: Comment PR with results
        if: failure()
        continue-on-error: true  # å³ä½¿è¯„è®ºå¤±è´¥ä¹Ÿç»§ç»­
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let comment = '## ğŸš¨ Code Quality Check Failed\n\n';
            
            // è¯»å– Prettier æŠ¥å‘Š
            if (fs.existsSync('prettier-report.md')) {
              const prettierReport = fs.readFileSync('prettier-report.md', 'utf8');
              comment += '### Prettier Formatting Issues\n\n';
              comment += prettierReport;
              comment += '\n**Fix command:**\n```bash\nnpm run format\n```\n\n';
            }
            
            // è¯»å– ESLint æŠ¥å‘Š
            if (fs.existsSync('eslint-report.md')) {
              const eslintReport = fs.readFileSync('eslint-report.md', 'utf8');
              comment += '### ESLint Issues\n\n';
              comment += eslintReport;
            }
            
            comment += '\n---\n';
            comment += 'ğŸ’¡ **æç¤º**: åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è‡ªåŠ¨ä¿®å¤å¤§éƒ¨åˆ†é—®é¢˜:\n';
            comment += '```bash\n';
            comment += '# åç«¯ä»£ç \n';
            comment += 'npm run format    # ä¿®å¤åç«¯ Prettier æ ¼å¼é—®é¢˜\n';
            comment += 'npm run lint      # ä¿®å¤åç«¯ ESLint é—®é¢˜\n';
            comment += '\n';
            comment += '# å‰ç«¯ä»£ç \n';
            comment += 'cd web/admin-spa\n';
            comment += 'npm run format    # ä¿®å¤å‰ç«¯ Prettier æ ¼å¼é—®é¢˜\n';
            comment += 'npm run lint      # ä¿®å¤å‰ç«¯ ESLint é—®é¢˜\n';
            comment += '```\n';
            
            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Code Quality Check Failed')
            );
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Success comment
        if: success() && steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true  # å³ä½¿è¯„è®ºå¤±è´¥ä¹Ÿç»§ç»­
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰å¤±è´¥çš„è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Code Quality Check Failed')
            );
            
            if (botComment) {
              // å¦‚æœä¹‹å‰æœ‰å¤±è´¥è¯„è®ºï¼Œæ›´æ–°ä¸ºæˆåŠŸ
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: '## âœ… Code Quality Check Passed\n\nAll files are properly formatted and pass linting checks!'
              });
            }