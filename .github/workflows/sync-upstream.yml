name: Sync Fork with Upstream

on:
  # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ä¸Šæ¸¸æ›´æ–°ï¼ˆå¹³è¡¡åŠæ—¶æ€§å’Œèµ„æºæ¶ˆè€—ï¼‰
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆ0æ—¶ã€6æ—¶ã€12æ—¶ã€18æ—¶ï¼‰
  
  # å½“ä½ çš„ä»“åº“æœ‰ push æ—¶ä¹Ÿè§¦å‘ï¼ˆç¡®ä¿æœ¬åœ°æ›´æ”¹ä¸è¢«è¦†ç›–ï¼‰
  push:
    branches:
      - main
      - master
      - dev
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sync_branch:
        description: 'Branch to sync (leave empty for all branches)'
        required: false
        type: string
      force_sync:
        description: 'Force sync even if there are conflicts'
        required: false
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    # é˜²æ­¢å¹¶å‘è¿è¡Œå¯¼è‡´å†²çª
    concurrency:
      group: sync-upstream
      cancel-in-progress: false
    
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          # ä¸Šæ¸¸ä»“åº“åœ°å€
          UPSTREAM_REPO="https://github.com/Wei-Shaw/claude-relay-service.git"
          
          echo "Adding upstream remote: $UPSTREAM_REPO"
          git remote add upstream $UPSTREAM_REPO || git remote set-url upstream $UPSTREAM_REPO
          git fetch upstream

      - name: Check for updates
        id: check
        run: |
          # èŽ·å–å½“å‰åˆ†æ”¯åç§°
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $CURRENT_BRANCH"
          
          # å°è¯•å¤šç§æ–¹å¼èŽ·å–é»˜è®¤åˆ†æ”¯
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            DEFAULT_BRANCH="main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            DEFAULT_BRANCH="master"
          elif git show-ref --verify --quiet refs/remotes/origin/dev; then
            DEFAULT_BRANCH="dev"
          else
            # èŽ·å–ç¬¬ä¸€ä¸ªè¿œç¨‹åˆ†æ”¯ä½œä¸ºé»˜è®¤
            DEFAULT_BRANCH=$(git branch -r | grep -v HEAD | head -1 | sed 's@.*origin/@@')
          fi
          
          echo "Default branch detected: $DEFAULT_BRANCH"
          echo "default_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          
          # ç¡®ä¿ä¸Šæ¸¸åˆ†æ”¯å­˜åœ¨
          if ! git show-ref --verify --quiet refs/remotes/upstream/$DEFAULT_BRANCH; then
            echo "âŒ Upstream branch $DEFAULT_BRANCH not found"
            echo "Available upstream branches:"
            git branch -r | grep upstream || echo "No upstream branches found"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æäº¤
          git checkout $DEFAULT_BRANCH 2>/dev/null || git checkout -b $DEFAULT_BRANCH origin/$DEFAULT_BRANCH
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/$DEFAULT_BRANCH)
          
          echo "Local commit: $LOCAL_COMMIT"
          echo "Upstream commit: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Found new commits in upstream repository"
            git log --oneline HEAD..upstream/$DEFAULT_BRANCH | head -20 || true
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date with upstream"
          fi

      - name: Sync default branch
        if: steps.check.outputs.has_updates == 'true'
        run: |
          DEFAULT_BRANCH="${{ steps.check.outputs.default_branch }}"
          echo "ðŸ”„ Syncing $DEFAULT_BRANCH branch..."
          
          # ç¡®ä¿æˆ‘ä»¬åœ¨æ­£ç¡®çš„åˆ†æ”¯ä¸Š
          git checkout $DEFAULT_BRANCH || git checkout -b $DEFAULT_BRANCH origin/$DEFAULT_BRANCH
          
          # ä¿å­˜æœ¬åœ°æ›´æ”¹ï¼ˆå¦‚æžœæœ‰ï¼‰
          git stash save "Auto-stash before sync" || true
          
          # å°è¯•è‡ªåŠ¨åˆå¹¶
          if git merge upstream/$DEFAULT_BRANCH --no-edit --allow-unrelated-histories; then
            echo "âœ… Successfully merged upstream changes"
            # å°è¯•æ¢å¤æœ¬åœ°æ›´æ”¹
            git stash pop || true
            git push origin $DEFAULT_BRANCH
          elif [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "âš ï¸ Conflicts detected, using force sync..."
            git reset --hard upstream/$DEFAULT_BRANCH
            git push --force-with-lease origin $DEFAULT_BRANCH
          else
            echo "âŒ Merge conflicts detected. Attempting automatic resolution..."
            # å°è¯•ä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬è§£å†³å†²çª
            git reset --hard upstream/$DEFAULT_BRANCH
            git push --force-with-lease origin $DEFAULT_BRANCH || {
              echo "Failed to sync. Please resolve manually or run with force_sync=true"
              exit 1
            }
          fi

      - name: Sync all other branches
        if: steps.check.outputs.has_updates == 'true' && github.event.inputs.sync_branch == ''
        continue-on-error: true
        run: |
          echo "ðŸ”„ Syncing other branches..."
          
          # åŒæ­¥å…¶ä»–é‡è¦åˆ†æ”¯
          for branch in dev staging production; do
            if git ls-remote --heads upstream | grep -q "refs/heads/$branch"; then
              echo "Syncing branch: $branch"
              
              # èŽ·å–æœ¬åœ°å’Œä¸Šæ¸¸çš„ commit
              LOCAL=$(git rev-parse --verify origin/$branch 2>/dev/null || echo "none")
              UPSTREAM=$(git rev-parse upstream/$branch)
              
              if [ "$LOCAL" != "$UPSTREAM" ]; then
                git checkout -B $branch upstream/$branch
                git push --force-with-lease origin $branch || echo "Failed to push $branch"
              fi
            fi
          done

      - name: Sync specific branch
        if: github.event.inputs.sync_branch != ''
        run: |
          BRANCH="${{ github.event.inputs.sync_branch }}"
          echo "ðŸ”„ Syncing specific branch: $BRANCH"
          
          if git ls-remote --heads upstream | grep -q "refs/heads/$BRANCH"; then
            git checkout -B $BRANCH upstream/$BRANCH
            git push --force-with-lease origin $BRANCH
            echo "âœ… Successfully synced $BRANCH"
          else
            echo "âŒ Branch $BRANCH not found in upstream"
            exit 1
          fi

      - name: Create sync report
        if: always()
        run: |
          echo "## ðŸ“Š Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Updates Found**: ${{ steps.check.outputs.has_updates }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Default Branch**: ${{ steps.check.outputs.default_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.has_updates }}" == "true" ]; then
            echo "### Recent commits from upstream:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git log --oneline HEAD..upstream/${{ steps.check.outputs.default_branch }} | head -10 >> $GITHUB_STEP_SUMMARY || echo "No new commits" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi