# è´¦æˆ·è¿‡æœŸæ—¶é—´ç®¡ç†åŠŸèƒ½ - ä»£ç è¯„å®¡æŠ¥å‘Šï¼ˆæœªä¿®å¤é—®é¢˜ï¼‰

## ğŸ“‹ è¯„å®¡æ¦‚è¿°

**è¯„å®¡èŒƒå›´**: åŠŸèƒ½åˆ†æ”¯ feature/account-subscription-expiry-check
**è¯„å®¡æ—¥æœŸ**: 2025-10-14
**åŠŸèƒ½çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œ9 ç§è´¦æˆ·ç±»å‹å…¨è¦†ç›–ï¼Œå†å² bug å·²å…¨éƒ¨ä¿®å¤

**æœ¬æ–‡æ¡£ä»…åŒ…å«æœªä¿®å¤çš„é—®é¢˜å’Œéœ€è¦æƒè¡¡è®¨è®ºçš„ä¼˜åŒ–å»ºè®®ã€‚**

---

## ğŸ” æœªä¿®å¤é—®é¢˜æ¸…å•

### âš ï¸ é—®é¢˜ 1: è¿‡æœŸæ£€æŸ¥é€»è¾‘é‡å¤ï¼ˆä»£ç å¤ç”¨ï¼‰

**é—®é¢˜æè¿°**:
`isSubscriptionExpired()` æ–¹æ³•åœ¨ 9 ä¸ªè´¦æˆ·æœåŠ¡æ–‡ä»¶ä¸­é‡å¤å®ç°äº†ç›¸åŒçš„é€»è¾‘ï¼ˆæ¯ä¸ªçº¦ 10 è¡Œä»£ç ï¼‰ã€‚

**å½±å“æ–‡ä»¶**:
- `src/services/claudeAccountService.js`
- `src/services/claudeConsoleAccountService.js`
- `src/services/ccrAccountService.js`
- `src/services/bedrockAccountService.js`
- `src/services/geminiAccountService.js`
- `src/services/openaiAccountService.js`
- `src/services/azureOpenaiAccountService.js`
- `src/services/openaiResponsesAccountService.js`
- `src/services/droidAccountService.js`

**æ˜¯å¦éœ€è¦ä¿®å¤**: âš ï¸ **å¯é€‰**
**ä¼˜å…ˆçº§**: **ä½**

**è¯„ä¼°ç†ç”±**:
- âœ… å½“å‰é€»è¾‘ç®€å•ï¼ˆä»… 10 è¡Œä»£ç ï¼‰ï¼Œé‡å¤æˆæœ¬å¯æ¥å—
- âœ… å„æœåŠ¡æ¶æ„ä¸å®Œå…¨ä¸€è‡´ï¼Œå¼ºè¡ŒæŠ½è±¡å¯èƒ½å¢åŠ å¤æ‚åº¦
- âœ… å¦‚æœæœªæ¥éœ€è¦ä¸ºä¸åŒè´¦æˆ·ç±»å‹å®šåˆ¶è¿‡æœŸé€»è¾‘ï¼Œç‹¬ç«‹å®ç°æ›´çµæ´»
- âš ï¸ å¦‚æœåç»­éœ€è¦ç»Ÿä¸€ä¿®æ”¹è¿‡æœŸæ£€æŸ¥é€»è¾‘ï¼Œéœ€è¦æ”¹ 9 ä¸ªæ–‡ä»¶

**å»ºè®®**:
- **ä¿æŒç°çŠ¶**ï¼Œé™¤éåç»­éœ€è¦ä¿®æ”¹è¿‡æœŸæ£€æŸ¥é€»è¾‘æ—¶å†è€ƒè™‘ç»Ÿä¸€æŠ½è±¡
- å¦‚æœè¦ä¼˜åŒ–ï¼Œå¯ä»¥åˆ›å»º `src/utils/accountExpiry.js` å·¥å…·å‡½æ•°ï¼š
  ```javascript
  // ç¤ºä¾‹ä»£ç 
  function isSubscriptionExpired(account) {
    if (!account.subscriptionExpiresAt) return false
    return new Date(account.subscriptionExpiresAt) <= new Date()
  }
  ```

---

### âš ï¸ é—®é¢˜ 2: `expiresAt` å­—æ®µè¯­ä¹‰é‡è½½

**é—®é¢˜æè¿°**:
åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­ï¼Œ`expiresAt` æœ‰ä¸åŒå«ä¹‰ï¼š
1. **OAuth token è¿‡æœŸæ—¶é—´** (å¦‚ `openaiAccountService.js:576`)
2. **è´¦æˆ·è®¢é˜…è¿‡æœŸæ—¶é—´** (å¦‚ `claudeAccountService.js:187`)
3. **API å“åº”æ ¼å¼åŒ–** (å¦‚ `admin.js:2019`)

**ä»£ç ç¤ºä¾‹**:
```javascript
// OAuth token è¿‡æœŸæ—¶é—´
expiresAt: tokenExpiresAt,  // âŒ æ— æ³¨é‡Šè¯´æ˜

// è´¦æˆ·è®¢é˜…è¿‡æœŸæ—¶é—´
expiresAt: accountData.expiresAt,  // âŒ æ— æ³¨é‡Šï¼Œå®¹æ˜“æ··æ·†

// API å“åº”
expiresAt: subscriptionExpiresAt,  // âŒ å‰ç«¯å­—æ®µæ˜ å°„ï¼Œæ— è¯´æ˜
```

**æ˜¯å¦éœ€è¦ä¿®å¤**: âš ï¸ **éƒ¨åˆ†ä¿®å¤ï¼ˆæ·»åŠ æ³¨é‡Šï¼‰**
**ä¼˜å…ˆçº§**: **ä¸­**

**è¯„ä¼°ç†ç”±**:
- âœ… åç«¯å·²é€šè¿‡ `mapExpiryField()` ç»Ÿä¸€å¤„ç†å­—æ®µæ˜ å°„ï¼Œæ¶æ„åˆç†
- âš ï¸ ç¼ºå°‘æ³¨é‡Šå¯¼è‡´ä»£ç å¯è¯»æ€§é™ä½ï¼Œå®¹æ˜“åœ¨ç»´æŠ¤ä¸­æ··æ·†
- âŒ ä¸å»ºè®®é‡æ„å­—æ®µåï¼ˆä¼šå½±å“å‰ç«¯ï¼Œæ”¹åŠ¨è¿‡å¤§ï¼‰

**å»ºè®®**:
- âœ… **æ·»åŠ ä»£ç æ³¨é‡Š**ï¼ˆæˆæœ¬ä½ï¼Œæ”¶ç›Šé«˜ï¼‰
- åœ¨å…³é”®ä½ç½®æ·»åŠ æ³¨é‡Šè¯´æ˜ï¼š
  ```javascript
  // æ¨èæ ¼å¼
  expiresAt: tokenExpiresAt,              // OAuth access token è¿‡æœŸæ—¶é—´
  subscriptionExpiresAt: ...,             // è´¦æˆ·è®¢é˜…åˆ°æœŸæ—¶é—´ (ä¸šåŠ¡å­—æ®µ)
  expiresAt: subscriptionExpiresAt,       // å‰ç«¯æœŸæœ›çš„å­—æ®µå (è®¢é˜…è¿‡æœŸ)
  ```

---

### âœ… é—®é¢˜ 3: ç¼ºå°‘å­—æ®µå«ä¹‰çš„æ–‡æ¡£è¯´æ˜

**é—®é¢˜æè¿°**:
å…³é”®å­—æ®µï¼ˆå¦‚ `subscriptionExpiresAt`ã€`expiresAt`ï¼‰åœ¨ä»£ç ä¸­ç¼ºå°‘æ³¨é‡Šè¯´æ˜ã€‚

**å½±å“èŒƒå›´**:
- æ‰€æœ‰è´¦æˆ·æœåŠ¡çš„å­—æ®µå®šä¹‰å¤„
- API è·¯ç”±çš„å“åº”æ ¼å¼åŒ–ä»£ç 
- å‰ç«¯çš„å­—æ®µæ˜ å°„é€»è¾‘

**æ˜¯å¦éœ€è¦ä¿®å¤**: âœ… **å»ºè®®ä¿®å¤**
**ä¼˜å…ˆçº§**: **ä¸­**

**è¯„ä¼°ç†ç”±**:
- âœ… æ·»åŠ æ³¨é‡Šæˆæœ¬æä½ï¼ˆçº¦ 10 åˆ†é’Ÿï¼‰
- âœ… æ˜¾è‘—æå‡ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- âœ… å¯¹æœªæ¥å¼€å‘è€…éå¸¸æœ‰å¸®åŠ©

**å»ºè®®**:
åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ æ³¨é‡Šï¼š
1. **è´¦æˆ·æœåŠ¡å­—æ®µå®šä¹‰** (9 ä¸ªæ–‡ä»¶)
2. **API è·¯ç”±å“åº”æ ¼å¼åŒ–** (`src/routes/admin.js`)
3. **å‰ç«¯å­—æ®µæ˜ å°„** (`web/admin-spa/src/components/accounts/`)

---

### âš ï¸ é—®é¢˜ 4: ç¼ºå°‘è‡ªåŠ¨åŒ–æµ‹è¯•

**é—®é¢˜æè¿°**:
é¡¹ç›®ä¸­æ²¡æœ‰é’ˆå¯¹è¿‡æœŸæ—¶é—´åŠŸèƒ½çš„æµ‹è¯•æ–‡ä»¶ï¼ˆ`tests/accountExpiry.test.js` ä¸å­˜åœ¨ï¼‰ã€‚

**ç¼ºå¤±çš„æµ‹è¯•è¦†ç›–**:
- å•å…ƒæµ‹è¯•ï¼šè¿‡æœŸæ£€æŸ¥é€»è¾‘ï¼ˆå·²è¿‡æœŸã€æœªè¿‡æœŸã€æ— è®¾ç½®ï¼‰
- é›†æˆæµ‹è¯•ï¼šåˆ›å»º/æ›´æ–°è´¦æˆ·ã€è°ƒåº¦è¿‡æ»¤
- å‰ç«¯æµ‹è¯•ï¼šå¿«æ·é€‰é¡¹ã€è‡ªå®šä¹‰æ—¥æœŸã€æ—¶åŒºå¤„ç†

**æ˜¯å¦éœ€è¦ä¿®å¤**: âš ï¸ **å¯é€‰**
**ä¼˜å…ˆçº§**: **ä½**

**è¯„ä¼°ç†ç”±**:
- âœ… åŠŸèƒ½å·²ç»è¿‡äººå·¥æµ‹è¯•å’Œå¤šæ¬¡ bug ä¿®å¤ï¼Œå½“å‰è¿è¡Œç¨³å®š
- âš ï¸ è¯¥é¡¹ç›®æ•´ä½“ç¼ºå°‘æµ‹è¯•æ–‡ä»¶ï¼ˆä¸æ˜¯è¿™ä¸ªåŠŸèƒ½ç‰¹æœ‰çš„é—®é¢˜ï¼‰
- âš ï¸ æ·»åŠ æµ‹è¯•éœ€è¦å»ºç«‹å®Œæ•´çš„æµ‹è¯•æ¡†æ¶ï¼Œå·¥ä½œé‡è¾ƒå¤§ï¼ˆçº¦ 1-2 å¤©ï¼‰
- âŒ æµ‹è¯•æŠ•å…¥äº§å‡ºæ¯”ä¸é«˜ï¼ˆåŠŸèƒ½ç›¸å¯¹ç®€å•ä¸”ç¨³å®šï¼‰

**å»ºè®®**:
- å¦‚æœåç»­é¡¹ç›®å¼•å…¥æµ‹è¯•æ¡†æ¶ï¼ˆå¦‚ Jestï¼‰ï¼Œå†è¡¥å……æµ‹è¯•
- å½“å‰é˜¶æ®µä¸å»ºè®®ä¸ºå•ä¸ªåŠŸèƒ½å•ç‹¬å»ºç«‹æµ‹è¯•ä½“ç³»

---

### âš ï¸ é—®é¢˜ 5: æœåŠ¡å™¨ç«¯æ—¶åŒºå¤„ç†é£é™©

**é—®é¢˜æè¿°**:
æœåŠ¡å™¨ç«¯è¿‡æœŸæ£€æŸ¥ä½¿ç”¨ `new Date()` è·å–å½“å‰æ—¶é—´ï¼Œä¾èµ–æœåŠ¡å™¨æ—¶åŒºé…ç½®ã€‚

**å½“å‰å®ç°**:
```javascript
// claudeAccountService.js
const expiryDate = new Date(account.subscriptionExpiresAt)  // UTC æ—¶é—´
const now = new Date()  // æœåŠ¡å™¨æœ¬åœ°æ—¶é—´
if (expiryDate <= now) { ... }
```

**æ½œåœ¨é£é™©**:
- âš ï¸ æœåŠ¡å™¨æ—¶åŒºé…ç½®é”™è¯¯æ—¶ä¼šå¯¼è‡´è¿‡æœŸåˆ¤æ–­ä¸å‡†ç¡®
- âš ï¸ æ²¡æœ‰æ˜ç¡®ä½¿ç”¨ UTC æ—¶é—´æ¯”è¾ƒ

**æ˜¯å¦éœ€è¦ä¿®å¤**: âš ï¸ **å¯é€‰**
**ä¼˜å…ˆçº§**: **ä½**

**è¯„ä¼°ç†ç”±**:
- âœ… å‰ç«¯å·²æ­£ç¡®å¤„ç†æ—¶åŒºï¼ˆæœ¬åœ°æ—¶é—´ â†’ UTC å­˜å‚¨ï¼‰
- âœ… å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨é»˜è®¤ä½¿ç”¨ UTC æ—¶åŒº
- âš ï¸ å¦‚æœæœåŠ¡å™¨æ—¶åŒºé…ç½®æ­£ç¡®ï¼ŒåŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œ
- âš ï¸ æ˜¾å¼ä½¿ç”¨ UTC æ¯”è¾ƒæ›´ç¨³å¥

**å»ºè®®**:
å¦‚æœæ‹…å¿ƒæ—¶åŒºé—®é¢˜ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºæ˜¾å¼ UTC æ¯”è¾ƒï¼š
```javascript
// æ¨èå†™æ³•
const expiryTimestamp = new Date(account.subscriptionExpiresAt).getTime()
const nowTimestamp = Date.now()
if (expiryTimestamp <= nowTimestamp) { ... }
```

---

### âŒ é—®é¢˜ 6: æ€§èƒ½ä¼˜åŒ–å»ºè®®

**é—®é¢˜æè¿°**:
æ¯æ¬¡è´¦æˆ·è°ƒåº¦éƒ½ä¼šæ‰§è¡Œæ—¥æœŸæ¯”è¾ƒæ“ä½œã€‚

**æ€§èƒ½åˆ†æ**:
- âœ… æ—¥æœŸæ¯”è¾ƒæ˜¯éå¸¸è½»é‡çš„æ“ä½œï¼ˆå¾®ç§’çº§ï¼‰
- âœ… å½“å‰è´¦æˆ·æ•°é‡è¿œå°äº 1000ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥
- âš ï¸ å¦‚æœè´¦æˆ·æ•°é‡å¢é•¿åˆ° 1000+ï¼Œå¯èƒ½éœ€è¦ç¼“å­˜æœºåˆ¶

**æ˜¯å¦éœ€è¦ä¿®å¤**: âŒ **ä¸éœ€è¦**
**ä¼˜å…ˆçº§**: **æ— **

**è¯„ä¼°ç†ç”±**:
- âœ… å½“å‰å®ç°æ€§èƒ½å®Œå…¨è¶³å¤Ÿ
- âŒ è¿‡æ—©ä¼˜åŒ–ä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦
- âœ… ç­‰åˆ°å®é™…é‡åˆ°æ€§èƒ½ç“¶é¢ˆæ—¶å†ä¼˜åŒ–ï¼ˆYAGNI åŸåˆ™ï¼‰

**å»ºè®®**:
- **ä¿æŒç°çŠ¶**ï¼Œä¸åšä¼˜åŒ–
- å¦‚æœæœªæ¥è´¦æˆ·æ•°é‡è¶…è¿‡ 1000ï¼Œå†è€ƒè™‘ï¼š
  - ç¼“å­˜è¿‡æœŸçŠ¶æ€ï¼ˆå®šæœŸåˆ·æ–°ï¼‰
  - ä½¿ç”¨ Redis EXPIREAT å‘½ä»¤

---

## ğŸ“Š ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| é—®é¢˜             | æ˜¯å¦éœ€è¦ä¿®å¤ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥ä½œé‡ | å»ºè®®æ“ä½œ             |
| ---------------- | ------------ | ------ | ---------- | -------------------- |
| è¿‡æœŸæ£€æŸ¥é€»è¾‘é‡å¤ | âš ï¸ å¯é€‰      | ä½     | 1-2 å°æ—¶   | æš‚ä¸ä¿®å¤             |
| å­—æ®µè¯­ä¹‰é‡è½½     | âš ï¸ éƒ¨åˆ†ä¿®å¤  | ä¸­     | 10 åˆ†é’Ÿ    | æ·»åŠ æ³¨é‡Š             |
| ç¼ºå°‘ä»£ç æ³¨é‡Š     | âœ… å»ºè®®ä¿®å¤  | ä¸­     | 10 åˆ†é’Ÿ    | **å»ºè®®ç«‹å³æ·»åŠ æ³¨é‡Š** |
| ç¼ºå°‘è‡ªåŠ¨åŒ–æµ‹è¯•   | âš ï¸ å¯é€‰      | ä½     | 1-2 å¤©     | ç­‰é¡¹ç›®å¼•å…¥æµ‹è¯•æ¡†æ¶   |
| æ—¶åŒºå¤„ç†é£é™©     | âš ï¸ å¯é€‰      | ä½     | 15 åˆ†é’Ÿ    | å¯é€‰ä¿®å¤             |
| æ€§èƒ½ä¼˜åŒ–         | âŒ ä¸éœ€è¦    | æ—      | -          | ä¸åšä¼˜åŒ–             |

---

## âœ… æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒç»“è®º

åŠŸèƒ½å®ç°è´¨é‡å¾ˆé«˜ï¼ˆç»¼åˆè¯„åˆ† 4.5/5ï¼‰ï¼Œæ‰€æœ‰å‘ç°çš„"é—®é¢˜"å®é™…ä¸Šéƒ½æ˜¯**é•¿æœŸä¼˜åŒ–å»ºè®®**ï¼Œä¸æ˜¯å¿…é¡»ç«‹å³ä¿®å¤çš„ bugã€‚

### ç«‹å³å¯åšçš„ä¼˜åŒ–ï¼ˆ10 åˆ†é’Ÿï¼‰

âœ… **æ·»åŠ ä»£ç æ³¨é‡Š**ï¼ˆé—®é¢˜ 2 + é—®é¢˜ 3ï¼‰
åœ¨å…³é”®å­—æ®µå¤„æ·»åŠ ç®€çŸ­æ³¨é‡Šï¼Œæå‡ä»£ç å¯è¯»æ€§ï¼š
```javascript
// ç¤ºä¾‹ä½ç½®
// src/services/claudeAccountService.js:187-188
// src/routes/admin.js:2019
```

### å¯é€‰çš„ä¼˜åŒ–ï¼ˆæŒ‰éœ€å†³ç­–ï¼‰

âš ï¸ **å­—æ®µè¯­ä¹‰é‡è½½** - å¦‚æœå›¢é˜Ÿè®¤ä¸ºå­—æ®µæ··æ·†å½±å“ç»´æŠ¤ï¼Œå¯ä»¥é‡æ„
âš ï¸ **ä»£ç å¤ç”¨é‡æ„** - å¦‚æœåç»­éœ€è¦ç»Ÿä¸€ä¿®æ”¹é€»è¾‘ï¼Œå†è€ƒè™‘æŠ½è±¡
âš ï¸ **æ—¶åŒºæ˜¾å¼å¤„ç†** - å¦‚æœæ‹…å¿ƒæœåŠ¡å™¨æ—¶åŒºé…ç½®é—®é¢˜ï¼Œå¯ä»¥ä¿®æ”¹

### ä¸å»ºè®®ä¿®å¤çš„å†…å®¹

âŒ **è‡ªåŠ¨åŒ–æµ‹è¯•** - æŠ•å…¥äº§å‡ºæ¯”ä¸é«˜ï¼Œç­‰é¡¹ç›®æ•´ä½“å¼•å…¥æµ‹è¯•æ¡†æ¶
âŒ **æ€§èƒ½ä¼˜åŒ–** - å½“å‰æ€§èƒ½å®Œå…¨è¶³å¤Ÿï¼Œè¿‡æ—©ä¼˜åŒ–å¢åŠ å¤æ‚åº¦

---

**è¯„å®¡å®Œæˆæ—¶é—´**: 2025-10-14
**è¯„å®¡äºº**: Claude Code (AI Assistant)
